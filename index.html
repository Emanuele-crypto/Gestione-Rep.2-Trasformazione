<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Gestione Produzione Agrumi - Reparto 2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .header {
            background-color: #D4A017; /* Cambio colore a giallo ocra */
            color: white;
            padding: 15px 0;
            margin-bottom: 30px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: #f5efd4;
            font-weight: bold;
        }
        .stats-card {
            text-align: center;
            padding: 15px;
        }
        .stats-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #D4A017;
        }
        .tank-card {
            height: 100%;
            transition: all 0.3s;
        }
        .tank-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .btn-custom {
            background-color: #D4A017;
            color: white;
        }
        .btn-custom:hover {
            background-color: #b08612;
            color: white;
        }
        .tank-header {
            background-color: #f5efd4;
            text-align: center;
            font-weight: bold;
        }
        .required-field::after {
            content: " *";
            color: red;
        }
        .nav-tabs .nav-link.active {
            background-color: #f5efd4;
            border-color: #D4A017 #D4A017 #f5efd4;
            color: #D4A017;
            font-weight: bold;
        }
        .nav-tabs .nav-link {
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1>SIMONE GATTO PROD-REPARTO 2- TRASFORMAZIONE</h1>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-light" id="btn-reparto-1">
                        <i class="bi bi-arrow-left-circle"></i> Reparto 1
                    </button>
                    <span class="ms-3 badge bg-light text-dark">Reparto 2 - Trasformazione</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container mb-5">
        <!-- Statistiche -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-value" id="total-lotti">0</div>
                    <div>Lotti in Lavorazione</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-value" id="total-succo">0 L</div>
                    <div>Succo Totale</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-value" id="total-olio">0 L</div>
                    <div>Olio Essenziale</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-value" id="serbatoi-utilizzati">0/20</div>
                    <div>Serbatoi Utilizzati</div>
                </div>
            </div>
        </div>

        <!-- Form inserimento dati -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-pencil-square"></i> Inserimento Dati di Lavorazione
            </div>
            <div class="card-body">
                <form id="produzione-form">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="linea-trasformazione" class="form-label required-field">Linea di Trasformazione</label>
                            <select class="form-select" id="linea-trasformazione" required>
                                <option value="" selected disabled>Seleziona...</option>
                                <option value="BOE">BOE</option>
                                <option value="GOE INT">GOE INT</option>
                                <option value="B/SF">B/SF</option>
                                <option value="400">400</option>
                                <option value="ALTRA">ALTRA</option>
                            </select>
                            <div id="altra-linea-container" style="display: none;" class="mt-2">
                                <input type="text" class="form-control" id="altra-linea" placeholder="Specifica altra linea">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="fornitore" class="form-label required-field">Fornitore</label>
                            <select class="form-select" id="fornitore" required>
                                <option value="" selected disabled>Seleziona...</option>
                                <option value="ARCO">ARCO</option>
                                <option value="CI">CI</option>
                                <option value="RESTUCCIA">RESTUCCIA</option>
                                <option value="ALTRO">ALTRO</option>
                            </select>
                            <div id="altro-fornitore-container" style="display: none;" class="mt-2">
                                <input type="text" class="form-control" id="altro-fornitore" placeholder="Specifica altro fornitore">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="tipo-agrume" class="form-label required-field">Tipo Agrume</label>
                            <select class="form-select" id="tipo-agrume" required>
                                <option value="" selected disabled>Seleziona...</option>
                                <option value="Arance">Arance</option>
                                <option value="Arance Rosse">Arance Rosse</option>
                                <option value="Limoni">Limoni</option>
                                <option value="Mandarini">Mandarini</option>
                                <option value="Pompelmi">Pompelmi</option>
                                <option value="Altro">Altro</option>
                            </select>
                            <div id="altro-agrume-container" style="display: none;" class="mt-2">
                                <input type="text" class="form-control" id="altro-agrume" placeholder="Specifica altro agrume">
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="destinazione-essenza" class="form-label required-field">Destinazione Essenza</label>
                            <select class="form-select" id="destinazione-essenza" required>
                                <option value="" selected disabled>Seleziona...</option>
                                <option value="Bio">Bio</option>
                                <option value="Convenzionale">Convenzionale</option>
                                <option value="Non Trattato">Non Trattato</option>
                                <option value="Altra">Altra</option>
                            </select>
                            <div id="altra-essenza-container" style="display: none;" class="mt-2">
                                <input type="text" class="form-control" id="altra-essenza" placeholder="Specifica altra destinazione">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="certificazione" class="form-label required-field">Certificazione</label>
                            <select class="form-select" id="certificazione" required>
                                <option value="" selected disabled>Seleziona...</option>
                                <option value="BIO EU">BIO EU</option>
                                <option value="BIO DEMETER">BIO DEMETER</option>
                                <option value="CONVENZIONALE">CONVENZIONALE</option>
                                <option value="IGP">IGP</option>
                                <option value="ALTRO">ALTRO</option>
                            </select>
                            <div id="altra-certificazione-container" style="display: none;" class="mt-2">
                                <input type="text" class="form-control" id="altra-certificazione" placeholder="Specifica altra certificazione">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="quantita" class="form-label required-field">Quantità (kg)</label>
                            <input type="number" class="form-control" id="quantita" required min="1">
                        </div>
                    </div>

                    <h5 class="mt-4 mb-3 border-bottom pb-2">Destinazione Spremiture</h5>
                    
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="prima-spremitura" class="form-label">1ª Spremitura</label>
                            <select class="form-select" id="prima-spremitura">
                                <option value="" selected disabled>Seleziona...</option>
                                <option value="SERB 11000">SERB 11000</option>
                                <option value="SERB AZZ">SERB AZZ</option>
                                <option value="CISTERNA PL">CISTERNA PL</option>
                                <option value="CISTERNA VK">CISTERNA VK</option>
                                <option value="CISTERNA EF">CISTERNA EF</option>
                                <option value="NAT IN TINI CONSERVATO">NAT IN TINI CONSERVATO</option>
                                <option value="F.F.">F.F.</option>
                                <option value="F.T.C.">F.T.C.</option>
                                <option value="LATTE 20 KG">LATTE 20 KG</option>
                                <option value="VASCHETTE">VASCHETTE</option>
                                <option value="VASCHETTE ZUCCHERATE">VASCHETTE ZUCCHERATE</option>
                                <option value="REX">REX</option>
                                <option value="ACMA">ACMA</option>
                                <option value="GOGLIO 3 KG">GOGLIO 3 KG</option>
                                <option value="PET 100">PET 100</option>
                                <option value="PET 200">PET 200</option>
                                <option value="PET 480">PET 480</option>
                                <option value="CONCENTRATO">CONCENTRATO</option>
                                <option value="ALTRO">ALTRO</option>
                                <option value="Nessuna">Nessuna</option>
                            </select>
                            <div id="concentrato-container-prima" style="display: none;" class="mt-2">
                                <label for="grado-bx-prima" class="form-label">Grado °BX</label>
                                <select class="form-select" id="grado-bx-prima">
                                    <option value="" selected disabled>Seleziona...</option>
                                    <option value="32 BX">32 BX</option>
                                    <option value="38 BX">38 BX</option>
                                    <option value="40 BX">40 BX</option>
                                    <option value="45 BX">45 BX</option>
                                    <option value="48 BX">48 BX</option>
                                    <option value="55 BX">55 BX</option>
                                    <option value="58 BX">58 BX</option>
                                    <option value="60 BX">60 BX</option>
                                </select>
                                
                                <label for="tenore-polpa-prima" class="form-label mt-2">Tenore di Polpa</label>
                                <select class="form-select" id="tenore-polpa-prima">
                                    <option value="" selected disabled>Seleziona...</option>
                                    <option value="STANDARD">STANDARD</option>
                                    <option value="1-3%">1-3%</option>
                                    <option value="2%">2%</option>
                                    <option value="3%">3%</option>
                                    <option value="<7% SEMICLEAR"><7% SEMICLEAR</option>
                                    <option value="LIMPIDO">LIMPIDO</option>
                                </select>
                            </div>
                            <div class="mt-2">
                                <input type="number" class="form-control" id="quantita-prima" placeholder="Quantità (L)" min="0">
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <label for="seconda-spremitura" class="form-label">2ª Spremitura</label>
                            <select class="form-select" id="seconda-spremitura">
                                <option value="" selected disabled>Seleziona...</option>
                                <option value="SERB 11000">SERB 11000</option>
                                <option value="SERB AZZ">SERB AZZ</option>
                                <option value="CISTERNA PL">CISTERNA PL</option>
                                <option value="CISTERNA VK">CISTERNA VK</option>
                                <option value="CISTERNA EF">CISTERNA EF</option>
                                <option value="NAT IN TINI CONSERVATO">NAT IN TINI CONSERVATO</option>
                                <option value="F.F.">F.F.</option>
                                <option value="F.T.C.">F.T.C.</option>
                                <option value="LATTE 20 KG">LATTE 20 KG</option>
                                <option value="VASCHETTE">VASCHETTE</option>
                                <option value="VASCHETTE ZUCCHERATE">VASCHETTE ZUCCHERATE</option>
                                <option value="REX">REX</option>
                                <option value="ACMA">ACMA</option>
                                <option value="GOGLIO 3 KG">GOGLIO 3 KG</option>
                                <option value="PET 100">PET 100</option>
                                <option value="PET 200">PET 200</option>
                                <option value="PET 480">PET 480</option>
                                <option value="CONCENTRATO">CONCENTRATO</option>
                                <option value="ALTRO">ALTRO</option>
                                <option value="Nessuna">Nessuna</option>
                            </select>
                            <div id="concentrato-container-seconda" style="display: none;" class="mt-2">
                                <label for="grado-bx-seconda" class="form-label">Grado °BX</label>
                                <select class="form-select" id="grado-bx-seconda">
                                    <option value="" selected disabled>Seleziona...</option>
                                    <option value="32 BX">32 BX</option>
                                    <option value="38 BX">38 BX</option>
                                    <option value="40 BX">40 BX</option>
                                    <option value="45 BX">45 BX</option>
                                    <option value="48 BX">48 BX</option>
                                    <option value="55 BX">55 BX</option>
                                    <option value="58 BX">58 BX</option>
                                    <option value="60 BX">60 BX</option>
                                </select>
                                
                                <label for="tenore-polpa-seconda" class="form-label mt-2">Tenore di Polpa</label>
                                <select class="form-select" id="tenore-polpa-seconda">
                                    <option value="" selected disabled>Seleziona...</option>
                                    <option value="STANDARD">STANDARD</option>
                                    <option value="1-3%">1-3%</option>
                                    <option value="2%">2%</option>
                                    <option value="3%">3%</option>
                                    <option value="<7% SEMICLEAR"><7% SEMICLEAR</option>
                                    <option value="LIMPIDO">LIMPIDO</option>
                                </select>
                            </div>
                            <div class="mt-2">
                                <input type="number" class="form-control" id="quantita-seconda" placeholder="Quantità (L)" min="0">
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <label for="torchiato" class="form-label">Torchiato</label>
                            <select class="form-select" id="torchiato">
                                <option value="" selected disabled>Seleziona...</option>
                                <option value="SERB 11000">SERB 11000</option>
                                <option value="SERB AZZ">SERB AZZ</option>
                                <option value="CISTERNA PL">CISTERNA PL</option>
                                <option value="CISTERNA VK">CISTERNA VK</option>
                                <option value="CISTERNA EF">CISTERNA EF</option>
                                <option value="NAT IN TINI CONSERVATO">NAT IN TINI CONSERVATO</option>
                                <option value="F.F.">F.F.</option>
                                <option value="F.T.C.">F.T.C.</option>
                                <option value="LATTE 20 KG">LATTE 20 KG</option>
                                <option value="VASCHETTE">VASCHETTE</option>
                                <option value="VASCHETTE ZUCCHERATE">VASCHETTE ZUCCHERATE</option>
                                <option value="REX">REX</option>
                                <option value="ACMA">ACMA</option>
                                <option value="GOGLIO 3 KG">GOGLIO 3 KG</option>
                                <option value="PET 100">PET 100</option>
                                <option value="PET 200">PET 200</option>
                                <option value="PET 480">PET 480</option>
                                <option value="CONCENTRATO">CONCENTRATO</option>
                                <option value="ALTRO">ALTRO</option>
                                <option value="Nessuna">Nessuna</option>
                            </select>
                            <div id="concentrato-container-torchiato" style="display: none;" class="mt-2">
                                <label for="grado-bx-torchiato" class="form-label">Grado °BX</label>
                                <select class="form-select" id="grado-bx-torchiato">
                                    <option value="" selected disabled>Seleziona...</option>
                                    <option value="32 BX">32 BX</option>
                                    <option value="38 BX">38 BX</option>
                                    <option value="40 BX">40 BX</option>
                                    <option value="45 BX">45 BX</option>
                                    <option value="48 BX">48 BX</option>
                                    <option value="55 BX">55 BX</option>
                                    <option value="58 BX">58 BX</option>
                                    <option value="60 BX">60 BX</option>
                                </select>
                                
                                <label for="tenore-polpa-torchiato" class="form-label mt-2">Tenore di Polpa</label>
                                <select class="form-select" id="tenore-polpa-torchiato">
                                    <option value="" selected disabled>Seleziona...</option>
                                    <option value="STANDARD">STANDARD</option>
                                    <option value="1-3%">1-3%</option>
                                    <option value="2%">2%</option>
                                    <option value="3%">3%</option>
                                    <option value="<7% SEMICLEAR"><7% SEMICLEAR</option>
                                    <option value="LIMPIDO">LIMPIDO</option>
                                </select>
                            </div>
                            <div class="mt-2">
                                <input type="number" class="form-control" id="quantita-torchiato" placeholder="Quantità (L)" min="0">
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <label for="v-fiorentina" class="form-label">V. Fiorentina</label>
                            <select class="form-select" id="v-fiorentina">
                                <option value="" selected disabled>Seleziona...</option>
                                <option value="SERB 11000">SERB 11000</option>
                                <option value="SERB AZZ">SERB AZZ</option>
                                <option value="CISTERNA PL">CISTERNA PL</option>
                                <option value="CISTERNA VK">CISTERNA VK</option>
                                <option value="CISTERNA EF">CISTERNA EF</option>
                                <option value="NAT IN TINI CONSERVATO">NAT IN TINI CONSERVATO</option>
                                <option value="F.F.">F.F.</option>
                                <option value="F.T.C.">F.T.C.</option>
                                <option value="LATTE 20 KG">LATTE 20 KG</option>
                                <option value="VASCHETTE">VASCHETTE</option>
                                <option value="VASCHETTE ZUCCHERATE">VASCHETTE ZUCCHERATE</option>
                                <option value="REX">REX</option>
                                <option value="ACMA">ACMA</option>
                                <option value="GOGLIO 3 KG">GOGLIO 3 KG</option>
                                <option value="PET 100">PET 100</option>
                                <option value="PET 200">PET 200</option>
                                <option value="PET 480">PET 480</option>
                                <option value="CONCENTRATO">CONCENTRATO</option>
                                <option value="ALTRO">ALTRO</option>
                                <option value="Nessuna">Nessuna</option>
                            </select>
                            <div id="concentrato-container-fiorentina" style="display: none;" class="mt-2">
                                <label for="grado-bx-fiorentina" class="form-label">Grado °BX</label>
                                <select class="form-select" id="grado-bx-fiorentina">
                                    <option value="" selected disabled>Seleziona...</option>
                                    <option value="32 BX">32 BX</option>
                                    <option value="38 BX">38 BX</option>
                                    <option value="40 BX">40 BX</option>
                                    <option value="45 BX">45 BX</option>
                                    <option value="48 BX">48 BX</option>
                                    <option value="55 BX">55 BX</option>
                                    <option value="58 BX">58 BX</option>
                                    <option value="60 BX">60 BX</option>
                                </select>
                                
                                <label for="tenore-polpa-fiorentina" class="form-label mt-2">Tenore di Polpa</label>
                                <select class="form-select" id="tenore-polpa-fiorentina">
                                    <option value="" selected disabled>Seleziona...</option>
                                    <option value="STANDARD">STANDARD</option>
                                    <option value="1-3%">1-3%</option>
                                    <option value="2%">2%</option>
                                    <option value="3%">3%</option>
                                    <option value="<7% SEMICLEAR"><7% SEMICLEAR</option>
                                    <option value="LIMPIDO">LIMPIDO</option>
                                </select>
                            </div>
                            <div class="mt-2">
                                <input type="number" class="form-control" id="quantita-fiorentina" placeholder="Quantità (L)" min="0">
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-12">
                            <label for="note" class="form-label">Note</label>
                            <textarea class="form-control" id="note" rows="3"></textarea>
                        </div>
                    </div>

                    <div class="text-end mt-4">
                        <button type="button" class="btn btn-secondary me-2" id="btn-reset">
                            <i class="bi bi-x-circle"></i> Annulla
                        </button>
                        <button type="submit" class="btn btn-custom">
                            <i class="bi bi-save"></i> Salva Dati
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Stato Serbatoi -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-database-fill"></i> Stato Serbatoi
                <button class="btn btn-sm btn-outline-success float-end" id="btn-etichette">
                    <i class="bi bi-tag"></i> Gestione Etichette
                </button>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs mb-4" id="serbatoi-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="serbazz-tab" data-bs-toggle="tab" data-bs-target="#serbazz-content" type="button" role="tab">SERB AZZ</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="serb11000-tab" data-bs-toggle="tab" data-bs-target="#serb11000-content" type="button" role="tab">SERB 11000</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="serbdist-tab" data-bs-toggle="tab" data-bs-target="#serbdist-content" type="button" role="tab">SERB Distillatori</button>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="serbazz-content" role="tabpanel">
                        <div class="row">
                            <!-- I div per i serbatoi restano invariati -->
                            <!-- Per brevità, non ho incluso tutti i serbatoi che erano presenti nel codice originale -->
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="serb11000-content" role="tabpanel">
                        <div class="row">
                            <!-- I div per i serbatoi restano invariati -->
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="serbdist-content" role="tabpanel">
                        <div class="row">
                            <!-- I div per i serbatoi restano invariati -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Etichette Serbatoi -->
    <div class="modal fade" id="etichetteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title"><i class="bi bi-tag"></i> Etichetta Serbatoio <span id="serb-id"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="etichette-form">
                        <!-- I campi del form restano invariati -->
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-custom" id="btn-save-etichetta">Salva ed Etichetta</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Script JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script>
        $(document).ready(function() {
            // Dati di stato
            let lottiCount = 0;
            let succoTotale = 0;
            let olioTotale = 0;
            let serbatoi = {
                // I dati dei serbatoi restano invariati
            };
            
            // Gestione altra linea di trasformazione
            $("#linea-trasformazione").change(function() {
                if ($(this).val() === "ALTRA") {
                    $("#altra-linea-container").show();
                } else {
                    $("#altra
                      } else {
                    $("#altra-linea-container").hide();
                    $("#altra-linea").val("");
                }
            });
            
            // Gestione altro fornitore
            $("#fornitore").change(function() {
                if ($(this).val() === "ALTRO") {
                    $("#altro-fornitore-container").show();
                } else {
                    $("#altro-fornitore-container").hide();
                    $("#altro-fornitore").val("");
                }
            });
            
            // Gestione altro agrume
            $("#tipo-agrume").change(function() {
                if ($(this).val() === "Altro") {
                    $("#altro-agrume-container").show();
                } else {
                    $("#altro-agrume-container").hide();
                    $("#altro-agrume").val("");
                }
            });
            
            // Gestione altra destinazione essenza
            $("#destinazione-essenza").change(function() {
                if ($(this).val() === "Altra") {
                    $("#altra-essenza-container").show();
                } else {
                    $("#altra-essenza-container").hide();
                    $("#altra-essenza").val("");
                }
            });
            
            // Gestione altra certificazione
            $("#certificazione").change(function() {
                if ($(this).val() === "ALTRO") {
                    $("#altra-certificazione-container").show();
                } else {
                    $("#altra-certificazione-container").hide();
                    $("#altra-certificazione").val("");
                }
            });
            
            // Gestione opzione "CONCENTRATO" per prima spremitura
            $("#prima-spremitura").change(function() {
                if ($(this).val() === "CONCENTRATO") {
                    $("#concentrato-container-prima").show();
                } else {
                    $("#concentrato-container-prima").hide();
                    $("#grado-bx-prima").val("");
                    $("#tenore-polpa-prima").val("");
                }
            });
            
            // Gestione opzione "CONCENTRATO" per seconda spremitura
            $("#seconda-spremitura").change(function() {
                if ($(this).val() === "CONCENTRATO") {
                    $("#concentrato-container-seconda").show();
                } else {
                    $("#concentrato-container-seconda").hide();
                    $("#grado-bx-seconda").val("");
                    $("#tenore-polpa-seconda").val("");
                }
            });
            
            // Gestione opzione "CONCENTRATO" per torchiato
            $("#torchiato").change(function() {
                if ($(this).val() === "CONCENTRATO") {
                    $("#concentrato-container-torchiato").show();
                } else {
                    $("#concentrato-container-torchiato").hide();
                    $("#grado-bx-torchiato").val("");
                    $("#tenore-polpa-torchiato").val("");
                }
            });
            
            // Gestione opzione "CONCENTRATO" per v. fiorentina
            $("#v-fiorentina").change(function() {
                if ($(this).val() === "CONCENTRATO") {
                    $("#concentrato-container-fiorentina").show();
                } else {
                    $("#concentrato-container-fiorentina").hide();
                    $("#grado-bx-fiorentina").val("");
                    $("#tenore-polpa-fiorentina").val("");
                }
            });
            
            // Gestione etichetta - altro prodotto
            $("#etichetta-prodotto").change(function() {
                if ($(this).val() === "ALTRO") {
                    $("#altro-prodotto-container").show();
                } else {
                    $("#altro-prodotto-container").hide();
                    $("#altro-prodotto").val("");
                }
            });
            
            // Gestione etichetta - altra certificazione
            $("#etichetta-certificazione").change(function() {
                if ($(this).val() === "ALTRO") {
                    $("#etichetta-altra-certificazione-container").show();
                } else {
                    $("#etichetta-altra-certificazione-container").hide();
                    $("#etichetta-altra-certificazione").val("");
                }
            });
            
            // Gestione etichetta - altro fornitore
            $("#etichetta-fornitore").change(function() {
                if ($(this).val() === "ALTRO") {
                    $("#etichetta-altro-fornitore-container").show();
                } else {
                    $("#etichetta-altro-fornitore-container").hide();
                    $("#etichetta-altro-fornitore").val("");
                }
            });
            
            // Apertura modal etichette con serbatoio preselezionato
            $(document).on("click", "[data-bs-target='#etichetteModal']", function() {
                let serbId = $(this).data("serb");
                $("#serb-id").text(serbId);
                
                // Preselezione tipo serbatoio in base al prefisso
                if (serbId.includes("Azz")) {
                    $("#etichetta-tipo-serb").val("SERB AZZ");
                } else if (serbId.startsWith("S")) {
                    $("#etichetta-tipo-serb").val("SERB 11000");
                } else if (serbId.startsWith("D")) {
                    $("#etichetta-tipo-serb").val("SERB Distillatori");
                }
                
                // Se il serbatoio ha già dati, precompiliamo il form
                if (serbatoi[serbId].prodotto !== "-") {
                    $("#etichetta-prodotto").val(serbatoi[serbId].prodotto);
                    $("#etichetta-certificazione").val(serbatoi[serbId].certificazione);
                    $("#etichetta-fornitore").val(serbatoi[serbId].fornitore);
                    $("#etichetta-quantita").val(serbatoi[serbId].quantita);
                    $("#etichetta-data").val(serbatoi[serbId].data);
                    $("#etichetta-note").val(serbatoi[serbId].note || "");
                } else {
                    // Reset del form
                    $("#etichette-form")[0].reset();
                    
                    // Preseleziona il tipo di serbatoio
                    if (serbId.includes("Azz")) {
                        $("#etichetta-tipo-serb").val("SERB AZZ");
                    } else if (serbId.startsWith("S")) {
                        $("#etichetta-tipo-serb").val("SERB 11000");
                    } else if (serbId.startsWith("D")) {
                        $("#etichetta-tipo-serb").val("SERB Distillatori");
                    }
                    
                    $("#etichetta-data").val(new Date().toISOString().split("T")[0]);
                }
            });
            
            // Salvataggio etichetta serbatoio
            $("#btn-save-etichetta").click(function() {
                // Validazione
                if (!$("#etichetta-tipo-serb").val() || !$("#etichetta-prodotto").val() || 
                    !$("#etichetta-certificazione").val() || !$("#etichetta-fornitore").val() || 
                    !$("#etichetta-quantita").val() || !$("#etichetta-data").val()) {
                    alert("Compila tutti i campi obbligatori!");
                    return;
                }
                
                // Recupero valori
                let serbId = $("#serb-id").text();
                let tipoSerb = $("#etichetta-tipo-serb").val();
                let prodotto = $("#etichetta-prodotto").val();
                let certificazione = $("#etichetta-certificazione").val();
                let fornitore = $("#etichetta-fornitore").val();
                let quantita = $("#etichetta-quantita").val();
                let data = $("#etichetta-data").val();
                let note = $("#etichetta-note").val();
                
                // Gestione campi "ALTRO"
                if (prodotto === "ALTRO") {
                    prodotto = $("#altro-prodotto").val();
                }
                if (certificazione === "ALTRO") {
                    certificazione = $("#etichetta-altra-certificazione").val();
                }
                if (fornitore === "ALTRO") {
                    fornitore = $("#etichetta-altro-fornitore").val();
                }
                
                // Aggiornamento dati serbatoio
                serbatoi[serbId] = {
                    stato: "Occupato",
                    prodotto: prodotto,
                    quantita: parseInt(quantita),
                    certificazione: certificazione,
                    fornitore: fornitore,
                    data: data,
                    note: note
                };
                
                // Aggiornamento UI serbatoio
                updateTankUI(serbId);
                
                // Aggiornamento statistiche
                updateStats();
                
                // Chiusura modal
                var modal = bootstrap.Modal.getInstance(document.getElementById('etichetteModal'));
                modal.hide();
                
                alert("Etichetta salvata e serbatoio aggiornato con successo!");
            });
            
            // Pulsante reset form
            $("#btn-reset").click(function() {
                if (confirm("Vuoi davvero annullare? I dati inseriti andranno persi.")) {
                    $("#produzione-form")[0].reset();
                    $("[id$='-container']").hide();
                }
            });
            
            // Salvataggio dati produzione
            $("#produzione-form").submit(function(e) {
                e.preventDefault();
                
                // Raccolta dati
                let lineaTrasformazione = $("#linea-trasformazione").val();
                if (lineaTrasformazione === "ALTRA") {
                    lineaTrasformazione = $("#altra-linea").val();
                }
                
                let fornitore = $("#fornitore").val();
                if (fornitore === "ALTRO") {
                    fornitore = $("#altro-fornitore").val();
                }
                
                let tipoAgrume = $("#tipo-agrume").val();
                if (tipoAgrume === "Altro") {
                    tipoAgrume = $("#altro-agrume").val();
                }
                
                let destinazioneEssenza = $("#destinazione-essenza").val();
                if (destinazioneEssenza === "Altra") {
                    destinazioneEssenza = $("#altra-essenza").val();
                }
                
                let certificazione = $("#certificazione").val();
                if (certificazione === "ALTRO") {
                    certificazione = $("#altra-certificazione").val();
                }
                
                let quantita = parseInt($("#quantita").val());
                let note = $("#note").val();
                
                // Dati spremiture con supporto per concentrato
                let spremiture = {
                    prima: {
                        destinazione: $("#prima-spremitura").val(),
                        quantita: parseInt($("#quantita-prima").val()) || 0,
                        gradoBx: $("#prima-spremitura").val() === "CONCENTRATO" ? $("#grado-bx-prima").val() : null,
                        tenorePolpa: $("#prima-spremitura").val() === "CONCENTRATO" ? $("#tenore-polpa-prima").val() : null
                    },
                    seconda: {
                        destinazione: $("#seconda-spremitura").val(),
                        quantita: parseInt($("#quantita-seconda").val()) || 0,
                        gradoBx: $("#seconda-spremitura").val() === "CONCENTRATO" ? $("#grado-bx-seconda").val() : null,
                        tenorePolpa: $("#seconda-spremitura").val() === "CONCENTRATO" ? $("#tenore-polpa-seconda").val() : null
                    },
                    torchiato: {
                        destinazione: $("#torchiato").val(),
                        quantita: parseInt($("#quantita-torchiato").val()) || 0,
                        gradoBx: $("#torchiato").val() === "CONCENTRATO" ? $("#grado-bx-torchiato").val() : null,
                        tenorePolpa: $("#torchiato").val() === "CONCENTRATO" ? $("#tenore-polpa-torchiato").val() : null
                    },
                    fiorentina: {
                        destinazione: $("#v-fiorentina").val(),
                        quantita: parseInt($("#quantita-fiorentina").val()) || 0,
                        gradoBx: $("#v-fiorentina").val() === "CONCENTRATO" ? $("#grado-bx-fiorentina").val() : null,
                        tenorePolpa: $("#v-fiorentina").val() === "CONCENTRATO" ? $("#tenore-polpa-fiorentina").val() : null
                    }
                };
                
                // Verifica che almeno una spremitura sia selezionata
                if ((!spremiture.prima.destinazione || spremiture.prima.destinazione === "Nessuna") &&
                    (!spremiture.seconda.destinazione || spremiture.seconda.destinazione === "Nessuna") &&
                    (!spremiture.torchiato.destinazione || spremiture.torchiato.destinazione === "Nessuna") &&
                    (!spremiture.fiorentina.destinazione || spremiture.fiorentina.destinazione === "Nessuna")) {
                    alert("Seleziona almeno una destinazione per le spremiture!");
                    return;
                }
                
                // Verifica che le quantità siano specificate per le spremiture selezionate
                if ((spremiture.prima.destinazione && spremiture.prima.destinazione !== "Nessuna" && spremiture.prima.quantita <= 0) ||
                    (spremiture.seconda.destinazione && spremiture.seconda.destinazione !== "Nessuna" && spremiture.seconda.quantita <= 0) ||
                    (spremiture.torchiato.destinazione && spremiture.torchiato.destinazione !== "Nessuna" && spremiture.torchiato.quantita <= 0) ||
                    (spremiture.fiorentina.destinazione && spremiture.fiorentina.destinazione !== "Nessuna" && spremiture.fiorentina.quantita <= 0)) {
                    alert("Inserisci una quantità valida per ogni spremitura selezionata!");
                    return;
                }
                
                // Verifica che per ogni spremitura con "CONCENTRATO" siano specificati grado e tenore
                if ((spremiture.prima.destinazione === "CONCENTRATO" && (!spremiture.prima.gradoBx || !spremiture.prima.tenorePolpa)) ||
                    (spremiture.seconda.destinazione === "CONCENTRATO" && (!spremiture.seconda.gradoBx || !spremiture.seconda.tenorePolpa)) ||
                    (spremiture.torchiato.destinazione === "CONCENTRATO" && (!spremiture.torchiato.gradoBx || !spremiture.torchiato.tenorePolpa)) ||
                    (spremiture.fiorentina.destinazione === "CONCENTRATO" && (!spremiture.fiorentina.gradoBx || !spremiture.fiorentina.tenorePolpa))) {
                    alert("Per le spremiture con destinazione 'CONCENTRATO' devi specificare Grado °BX e Tenore di Polpa!");
                    return;
                }
                
                // Logica per allocare le spremiture ai serbatoi
                let allocazioni = allocateToTanks(spremiture, certificazione, fornitore);
                
                if (!allocazioni.success) {
                    alert(allocazioni.message);
                    return;
                }
                
                // Simulazione generazione ID lotto
                const now = new Date();
                const lottoId = "L-" + 
                               now.getFullYear() + 
                               padZero(now.getMonth() + 1) + 
                               padZero(now.getDate()) + "-" + 
                               padZero(now.getHours()) + 
                               padZero(now.getMinutes());
                
                // Incremento contatori
                lottiCount++;
                succoTotale += spremiture.prima.quantita + spremiture.seconda.quantita + 
                              spremiture.torchiato.quantita + spremiture.fiorentina.quantita;
                olioTotale += quantita * 0.01; // Simulazione 1% di olio essenziale
                
                // Aggiornamento statistiche
                updateStats();
                
                // Reset form
                $("#produzione-form")[0].reset();
                $("[id$='-container']").hide();
                
                alert("Dati di produzione salvati con successo!\nID Lotto: " + lottoId);
            });
            
            // Pulsante reparto 1
            $("#btn-reparto-1").click(function() {
                if (confirm("Passare al Reparto 1? Le modifiche non salvate andranno perse.")) {
                    alert("Collegamento al Reparto 1 simulato.");
                }
            });
            
            // FUNZIONI DI SUPPORTO
            
            // Allocazione ai serbatoi
            function allocateToTanks(spremiture, certificazione, fornitore) {
                // Verifica disponibilità serbatoi
                let needSerb11000 = 0;
                let needSerbAzz = 0;
                
                if (spremiture.prima.destinazione === "SERB 11000") needSerb11000++;
                if (spremiture.prima.destinazione === "SERB AZZ") needSerbAzz++;
                if (spremiture.seconda.destinazione === "SERB 11000") needSerb11000++;
                if (spremiture.seconda.destinazione === "SERB AZZ") needSerbAzz++;
                if (spremiture.torchiato.destinazione === "SERB 11000") needSerb11000++;
                if (spremiture.torchiato.destinazione === "SERB AZZ") needSerbAzz++;
                if (spremiture.fiorentina.destinazione === "SERB 11000") needSerb11000++;
                if (spremiture.fiorentina.destinazione === "SERB AZZ") needSerbAzz++;
                
                // Contiamo serbatoi disponibili
                let availSerb11000 = 0;
                let availSerbAzz = 0;
                
                for (let id in serbatoi) {
                    if (serbatoi[id].stato === "Disponibile") {
                        if (id.startsWith("S")) availSerb11000++;
                        if (id.includes("Azz")) availSerbAzz++;
                    }
                }
                
                if (needSerb11000 > availSerb11000 || needSerbAzz > availSerbAzz) {
                    return {
                        success: false,
                        message: "Non ci sono abbastanza serbatoi disponibili per allocare tutte le spremiture!"
                    };
                }
                
                // Allocazione ai serbatoi
                const today = new Date().toISOString().split("T")[0];
                
                // Funzione per trovare il prossimo serbatoio disponibile
                function nextAvailableTank(prefix) {
                    // Per serbatoi 11000 (S21-S30)
                    if (prefix === "S") {
                        for (let i = 21; i <= 30; i++) {
                            let id = "S" + i;
                            if (serbatoi[id].stato === "Disponibile") {
                                return id;
                            }
                        }
                    }
                    // Per serbatoi AZZ (1Azz-10Azz)
                    else if (prefix === "Azz") {
                        for (let i = 1; i <= 10; i++) {
                            let id = i + "Azz";
                            if (serbatoi[id].stato === "Disponibile") {
                                return id;
                            }
                        }
                    }
                    return null;
                }
                
                // Allocazione prima spremitura
                if (spremiture.prima.destinazione && spremiture.prima.destinazione !== "Nessuna") {
                    let tankId = null;
                    if (spremiture.prima.destinazione === "SERB 11000") {
                        tankId = nextAvailableTank("S");
                    } else if (spremiture.prima.destinazione === "SERB AZZ") {
                        tankId = nextAvailableTank("Azz");
                    }
                    
                    if (tankId) {
                        let prodottoInfo = "1ª SPREMITURA";
                        
                        // Aggiunta informazioni per concentrato
                        if (spremiture.prima.destinazione === "CONCENTRATO") {
                            prodottoInfo += " - " + spremiture.prima.gradoBx + " - " + spremiture.prima.tenorePolpa;
                        }
                        
                        serbatoi[tankId] = {
                            stato: "Occupato",
                            prodotto: prodottoInfo,
                            quantita: spremiture.prima.quantita,
                            certificazione: certificazione,
                            fornitore: fornitore,
                            data: today,
                            note: "Allocato automaticamente"
                        };
                        updateTankUI(tankId);
                    }
                }
                
                // Allocazioni simili per seconda, torchiato e fiorentina
                // [Lo stesso schema si ripete per le altre spremiture]
                
                return {
                    success: true
                };
            }
            
            // Aggiornamento UI serbatoio
            function updateTankUI(serbId) {
                const serbData = serbatoi[serbId];
                const serbCard = $(`[data-bs-target='#etichetteModal'][data-serb='${serbId}']`).closest(".card");
                
                if (serbData.stato === "Occupato") {
                    serbCard.find("strong:contains('Stato:')").next().removeClass("bg-success").addClass("bg-danger").text("Occupato");
                    serbCard.find("strong:contains('Prodotto:')").parent().text(`Prodotto: ${serbData.prodotto}`);
                    serbCard.find("strong:contains('Quantità:')").parent().text(`Quantità: ${serbData.quantita} L`);
                    serbCard.find("strong:contains('Certificazione:')").parent().text(`Certificazione: ${serbData.certificazione}`);
                } else {
                    serbCard.find("strong:contains('Stato:')").next().removeClass("bg-danger").addClass("bg-success").text("Disponibile");
                    serbCard.find("strong:contains('Prodotto:')").parent().text("Prodotto: -");
                    serbCard.find("strong:contains('Quantità:')").parent().text("Quantità: 0 L");
                    serbCard.find("strong:contains('Certificazione:')").parent().text("Certificazione: -");
                }
            }
            
            // Aggiornamento statistiche
            function updateStats() {
                $("#total-lotti").text(lottiCount);
                $("#total-succo").text(succoTotale + " L");
                $("#total-olio").text(olioTotale.toFixed(2) + " L");
                
                // Conteggio serbatoi utilizzati
                let usedTanks = 0;
                let totalTanks = Object.keys(serbatoi).length;
                
                for (let id in serbatoi) {
                    if (serbatoi[id].stato === "Occupato") {
                        usedTanks++;
                    }
                }
                $("#serbatoi-utilizzati").text(usedTanks + "/" + totalTanks);
            }
            
            // Utility per padding zeri
            function padZero(num) {
                return num < 10 ? "0" + num : num;
            }
            
            // Inizializzazione data nei form
            $("#etichetta-data").val(new Date().toISOString().split("T")[0]);
        });
    </script>
